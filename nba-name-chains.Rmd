---
title: "NBA Name Chains"
author: "Arya Muralidharan"
date: "TBD"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)

```

# Introduction

This project was inspired by [this tweet](https://twitter.com/travisyost/status/1124420117247381505), which lists some name chains of NHL players. I wanted to write a program that would generate name chains of NBA/ABA players!

```{r packages, message = FALSE, warning = FALSE}

library(here)
library(rvest)
library(tidyverse)

```

```{r parameters}

# list of letters in the alphabet except for 'x' - there are no NBA players with last names starting with 'x'
letter.list <- c("a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "y", "z")

# main part of the basketball-reference url
main.url <- "https://www.basketball-reference.com/players/"

# save files
codes.output <- "NBA_ABA_codes.rds"
names.output <- "NBA_ABA_full_names.rds"
clean.output <- "NBA_ABA_final_names.rds"
final.output <- "NBA_ABA_name_chains.rds"

```

# Data Scraping

All data comes from [Basketball Reference](https://www.basketball-reference.com/).

First we scrape all of Basketball Reference's player codes from each "NBA & ABA Players with Last Names Starting with [Letter]" page.

**Codes were last scraped on 2019/07/26.**

```{r scrape_codes}

all_codes <- list()

for(letter in letter.list){
  
 # read in letter page
  url_codes <- paste0(main.url, letter, "/")
  page_codes <- read_html(url_codes)
  
  # get player codes
  codes <- page_codes %>%
    html_nodes("table#players > tbody > tr > th") %>%
    html_attr("data-append-csv") %>%
    as.list()
  
  all_codes <- c(all_codes, codes)
}

# save locally
saveRDS(all_codes, here("data", codes.output))

```

Then we use the player codes to scrape the name of each player. 

_Why aren't we just scraping the names directly from the "NBA & ABA Players with Last Names Starting with [Letter]" pages? Because those pages often list a player's nickname, not legal first name._

**Names were last scraped on 2019/07/28.**

```{r scrape_names}

# all_codes <- readRDS(here("data", codes.output))

all_names <- list()

for(code in all_codes){
  
  letter <- substr(code, 1, 1)
  
  url <- paste0(main.url, letter, "/", code, ".html")
  page <- read_html(url)
  
  # get full name
  # when testing on the 'a' names, I found that there were three (3) different selectors
  name <- page %>%
    html_nodes("#meta > div > p:nth-child(2) > strong > strong") %>%
    html_text()
  if(identical(name, character(0))){
    name <- page %>%
      html_nodes("#meta > div:nth-child(2) > p:nth-child(3) > strong > strong") %>%
      html_text()
  }
  if(identical(name, character(0))){
    name <- page %>%
      html_nodes("#meta > div > p:nth-child(3) > strong > strong") %>%
      html_text()
  }
  all_names <- c(all_names, name)
  
}

# save locally
saveRDS(all_names, here("data", names.output))

```

# Name Chains

Now that we have the names of all players, we can start creating the name chains. But first, we need to remove suffixes, middle names, and duplicates.

```{r clean_names}

# all_names <- readRDS(here("data", names.output))

# remove suffixes and split into first, middle, last, etc.
final_names <- all_names %>%
  str_replace(" Jr.", "") %>%
  as.list() %>%
  str_replace(" Sr.", "") %>%
  as.list() %>%
  str_replace(" IV", "") %>%
  as.list() %>%
  str_replace(" III", "") %>%
  as.list() %>%
  str_replace(" II", "") %>%
  as.list() %>% 
  str_split(" ")

# turn this into a tibble
final_names <- final_names %>% 
  plyr::ldply(rbind) %>% 
  as_tibble()

# give columns real names
colnames(final_names) <- c("first", "two", "three", "four", "five")

# here's what's happening below:
# mutate: convert to character & create last name column
# mutate: fix some names
# select: keep only first and last names
# distinct: remove duplicates
final_names <- final_names %>%
  mutate(first = as.character(first),
         two = as.character(two),
         three = as.character(three), 
         four = as.character(four),
         five = as.character(five),
         last = case_when(!is.na(two) & is.na(three) ~ two,
                          !is.na(three) & is.na(four) ~ three,
                          !is.na(four) & is.na(five) ~ four,
                          !is.na(five) ~ five)) %>%
  mutate(first = case_when(last == "Watanabe" & first == "Watanabe" ~ "Yuta",
                           last == "Navarro" & first == "Juan" ~ "Juan Carlos",
                           TRUE ~ first),
         last = case_when(last == "Salle" & first == "George" ~ "Bon Salle",
                          last == "Colo" & first == "Nando" ~ "De Colo",
                          last == "Negro" & first == "Vincent" ~ "Del Negro",
                          last == "Arsdale" & first == "Richard" ~ "Van Arsdale",
                          last == "Arsdale" & first == "Thomas" ~ "Van Arsdale",
                          last == "Kolff" & first == "Willem" ~ "van Breda Kolff",
                          last == "Kolff" & first == "Jan" ~ "van Breda Kolff",
                          last == "Exel" & first == "Nickey" ~ "Van Exel",
                          last == "Horn" & first == "Keith" ~ "Van Horn",
                          last == "Lier" & first == "Norman" ~ "Van Lier",
                          last == "Zant" & first = "Dennis" ~ "Van Zant",
                          last == "Velden" & first == "Logan" ~ "Vander Velden",
                          last == "Peace" & first == "Metta" ~ "World Peace",
                          TRUE ~ last)) %>%
  select(first, last) %>%
  distinct()

# save locally
saveRDS(final_names, here("data", clean.output))

```

Most of this next chunk isn't strictly necessary--we could skip to the following chunk and replace every instance of "step_00x" (apart from "step_001," which is necessary) with "final_names" and it would work.

However, creating tinier and tinier tibbles in this chunk makes the following chunk faster to run, as R only needs to search through a maximum of 1229 rows for name matches as opposed to searching though 4587 rows every time.

```{r data_frames_manual}

# final_names <- readRDS(here("data", clean.output))

# step_001: reasonable starting points - players with last names that are others' first names
step_001 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,2] %>% as.character()
  if(name %in% final_names$first){
    step_001 <- bind_rows(step_001, final_names[i,])
  }
}

# step_002: find first names that match the last names of the previous step
step_002 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_001$last){
    step_002 <- bind_rows(step_002, final_names[i,])
  }
}

# step_003: find first names that match the last names of the previous step
step_003 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_002$last){
    step_003 <- bind_rows(step_003, final_names[i,])
  }
}

# step_004...
step_004 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_003$last){
    step_004 <- bind_rows(step_004, final_names[i,])
  }
}

# step_005...
step_005 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_004$last){
    step_005 <- bind_rows(step_005, final_names[i,])
  }
}

# step_006..
step_006 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_005$last){
    step_006 <- bind_rows(step_006, final_names[i,])
  }
}

# step_007..
step_007 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_006$last){
    step_007 <- bind_rows(step_007, final_names[i,])
  }
}

# step_008.
step_008 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_007$last){
    step_008 <- bind_rows(step_008, final_names[i,])
  }
}

# step_009.
step_009 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_008$last){
    step_009 <- bind_rows(step_009, final_names[i,])
  }
}

# step_010
step_010 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_009$last){
    step_010 <- bind_rows(step_010, final_names[i,])
  }
}

# step_011
step_011 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_010$last){
    step_011 <- bind_rows(step_011, final_names[i,])
  }
}

# step_012
step_012 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_011$last){
    step_012 <- bind_rows(step_012, final_names[i,])
  }
}

# step_013
step_013 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_012$last){
    step_013 <- bind_rows(step_013, final_names[i,])
  }
}

# step_014
step_014 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_013$last){
    step_014 <- bind_rows(step_014, final_names[i,])
  }
}

# step_015: the final step!
step_015 <- tibble()

for(i in 1:nrow(final_names)){
  name <- final_names[i,1] %>% as.character()
  if(name %in% step_014$last){
    step_015 <- bind_rows(step_015, final_names[i,])
  }
}

```

Aaaand finally! Some name chains! 

Each set of name chains has all of the name chains of one length (in this case, from three names to sixteen names); after the first chain, all subsequent chains build off each other!

```{r name_chains_manual}

# chains_01
chains_01 <- tibble()
chain <- tibble() %>% 
  mutate(col_01 = character(),
         col_02 = character(),
         col_03 = character())

for(i in 1:nrow(step_001)){
  for(j in 1:nrow(step_002)){
    if(step_001[i,2] == step_002[j,1]){
      chain[1,][1:2] = step_001[i,][1:2]
      chain[1,3] = step_002[j,2]
      
      chains_01 <- rbind(chains_01, chain)
    }
  }
}

# chains_02
chains_02 <- tibble()
chain <- chain %>% 
  mutate(col_04 = NA_character_)

for(i in 1:nrow(chains_01)){
  for(j in 1:nrow(step_003)){
    if(chains_01[i,3] == step_003[j,1]){
      chain[1,][1:3] = chains_01[i,][1:3]
      chain[1,4] = step_003[j,2]
      
      chains_02 <- rbind(chains_02, chain)
    }
  }
}

# chains_03
chains_03 <- tibble()
chain <- chain %>% 
  mutate(col_05 = NA_character_)

for(i in 1:nrow(chains_02)){
  for(j in 1:nrow(step_004)){
    if(chains_02[i,4] == step_004[j,1]){
      chain[1,][1:4] = chains_02[i,][1:4]
      chain[1,5] = step_004[j,2]
      
      chains_03 <- rbind(chains_03, chain)
    }
  }
}

# chains_04
chains_04 <- tibble()
chain <- chain %>% 
  mutate(col_06 = NA_character_)

for(i in 1:nrow(chains_03)){
  for(j in 1:nrow(step_005)){
    if(chains_03[i,5] == step_005[j,1]){
      chain[1,][1:5] = chains_03[i,][1:5]
      chain[1,6] = step_005[j,2]
      
      chains_04 <- rbind(chains_04, chain)
    }
  }
}

# chains_05
chains_05 <- tibble()
chain <- chain %>% 
  mutate(col_07 = NA_character_)

for(i in 1:nrow(chains_04)){
  for(j in 1:nrow(step_006)){
    if(chains_04[i,6] == step_006[j,1]){
      chain[1,][1:6] = chains_04[i,][1:6]
      chain[1,7] = step_006[j,2]
      
      chains_05 <- rbind(chains_05, chain)
    }
  }
}

# chains_06
chains_06 <- tibble()
chain <- chain %>% 
  mutate(col_08 = NA_character_)

for(i in 1:nrow(chains_05)){
  for(j in 1:nrow(step_007)){
    if(chains_05[i,7] == step_007[j,1]){
      chain[1,][1:7] = chains_05[i,][1:7]
      chain[1,8] = step_007[j,2]
      
      chains_06 <- rbind(chains_06, chain)
    }
  }
}

# chains_07
chains_07 <- tibble()
chain <- chain %>% 
  mutate(col_09 = NA_character_)

for(i in 1:nrow(chains_06)){
  for(j in 1:nrow(step_008)){
    if(chains_06[i,8] == step_008[j,1]){
      chain[1,][1:8] = chains_06[i,][1:8]
      chain[1,9] = step_008[j,2]
      
      chains_07 <- rbind(chains_07, chain)
    }
  }
}

# chains_08
chains_08 <- tibble()
chain <- chain %>%
  mutate(col10 = NA_character_)

for(i in 1:nrow(chains_07)){
  for(j in 1:nrow(step_009)){
    if(chains_07[i,9] == step_009[j,1]){
      chain[1,][1:9] = chains_07[i,][1:9]
      chain[1,10] = step_009[j,2]
      
      chains_08 <- rbind(chains_08, chain)
    }
  }
}

# chains_09
chains_09 <- tibble()
chain <- chain %>%
  mutate(col11 = NA_character_)

for(i in 1:nrow(chains_08)){
  for(j in 1:nrow(step_010)){
    if(chains_08[i,10] == step_010[j,1]){
      chain[1,][1:10] = chains_08[i,][1:10]
      chain[1,11] = step_010[j,2]
      
      chains_09 <- rbind(chains_09, chain)
    }
  }
}

# chains_10
chains_10 <- tibble()
chain <- chain %>%
  mutate(col12 = NA_character_)

for(i in 1:nrow(chains_09)){
  for(j in 1:nrow(step_011)){
    if(chains_09[i,11] == step_011[j,1]){
      chain[1,][1:11] = chains_09[i,][1:11]
      chain[1,12] = step_011[j,2]
      
      chains_10 <- rbind(chains_10, chain)
    }
  }
}

# chains_11
chains_11 <- tibble()
chain <- chain %>%
  mutate(col13 = NA_character_)

for(i in 1:nrow(chains_10)){
  for(j in 1:nrow(step_012)){
    if(chains_10[i,12] == step_012[j,1]){
      chain[1,][1:12] = chains_10[i,][1:12]
      chain[1,13] = step_012[j,2]
      
      chains_11 <- rbind(chains_11, chain)
    }
  }
}

# chains_12
chains_12 <- tibble()
chain <- chain %>%
  mutate(col14 = NA_character_)

for(i in 1:nrow(chains_11)){
  for(j in 1:nrow(step_013)){
    if(chains_11[i,13] == step_013[j,1]){
      chain[1,][1:13] = chains_11[i,][1:13]
      chain[1,14] = step_013[j,2]
      
      chains_12 <- rbind(chains_12, chain)
    }
  }
}

# chains_13
chains_13 <- tibble()
chain <- chain %>%
  mutate(col15 = NA_character_)

for(i in 1:nrow(chains_12)){
  for(j in 1:nrow(step_014)){
    if(chains_12[i,14] == step_014[j,1]){
      chain[1,][1:14] = chains_12[i,][1:14]
      chain[1,15] = step_014[j,2]
      
      chains_13 <- rbind(chains_13, chain)
    }
  }
}

# chains_14
chains_14 <- tibble()
chain <- chain %>%
  mutate(col16 = NA_character_)

for(i in 1:nrow(chains_13)){
  for(j in 1:nrow(step_015)){
    if(chains_13[i,15] == step_015[j,1]){
      chain[1,][1:15] = chains_13[i,][1:15]
      chain[1,16] = step_015[j,2]
      
      chains_14 <- rbind(chains_14, chain)
    }
  }
}

```

The final product! We bind all the sets of name chains together to make One Giant Tibble.

```{r}

# the full list of name chains - bind all the chains tibbles together
name_chains <- list(chains_01, chains_02, chains_03, chains_04, chains_05, chains_06, chains_07, chains_08, chains_09, chains_10, chains_11, chains_12, chains_13, chains_14) %>% 
  bind_rows()

# save locally
saveRDS(name_chains, here("data", final.output))

```

Future updates:
* Adding to the code/name lists without having to re-scrape everything